<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Garbage Typewriter</title>
</head>
<body>
    <div>Requires an epson printer to work</div>
    <form id="form-container">
        <br/>
        <label>
            Type in a sentence <br/>
            <input type="text" id="typewriter-input"/>
        </label>
        <br/><br/>
        <div>
            <button type="button" id="find-printer">Find Printers</button>
            <button  type="button" id="connect-printer">Connect Printer</button>
            <button  type="button" id="cut-printer">Cut Page</button>
            <img src="echo.png" alt="" id="test-image">
        </div>
    </form>


    <script>
        // Epson printer specific codes
        const INIT_PRINT = '\x1B' + '\x40';
        const LINE_BREAK = '\x0A';
        const CUT_PAPER = '\x1B' + '\x69';
        const UNDERLINE_MODE = '\x1B' + '\x65';


        // USB devices can have 1-16 possible endpoints that can be connected to
        // we don't know what endpoint we need to connect to to send a successful print command
        // so we just start at endpoint 1, and we shuffle until 16 to see which endpoint the printer is using
        let endpointNumber = 1;

        const getDevices = async () => navigator.usb.getDevices().then(([printer]) => Promise.resolve(printer));

        const sendMessageToPrinter = (device, content) => {
            const encoder = new TextEncoder();

            const data = encoder.encode(content);

            console.log('trying ', endpointNumber)

            return device.transferOut(endpointNumber, data);
        }

        const startPrint = async  (device, content) => sendMessageToPrinter(device, content.join('')).catch(e => {
            if (e.message.includes('The specified endpoint is not part of a claimed and selected alternate interface')) {
                if (endpointNumber < 15) {
                    endpointNumber = endpointNumber + 1;
                    startPrint(device, content);
                    return;
                }

                console.log('failed!');
                return;
            }

            console.error('Send Error:', e);
        }).then(e => console.log(e))


        let device;

        const requestPrinter = () => {
            navigator.usb.requestDevice({
                filters: [],
            });
        }

        const initPrinter = async () => {
            device = await getDevices();

            await device.open();
            await device.selectConfiguration(1);

            device.claimInterface(
                device.configuration.interfaces[0].interfaceNumber
            );

            endpointNumber = 1;
        };

        const cutPrinter = () => {
            startPrint(device, [INIT_PRINT, LINE_BREAK, LINE_BREAK, LINE_BREAK, LINE_BREAK, CUT_PAPER]);
        }

        document.getElementById('form-container').onsubmit = (e) => e.preventDefault();

        let buffer = '';
        document.getElementById('typewriter-input').addEventListener('keydown', (e) => {
            const code = (e.keyCode ? e.keyCode : e.which);

            if  (code === 13) { //Enter keycode
                startPrint(device, [INIT_PRINT, UNDERLINE_MODE, buffer, LINE_BREAK]);
                document.getElementById('form-container').reset();
                setTimeout(() => document.getElementById('typewriter-input').focus(), 100)
                buffer = '';

                return;
            }

            buffer += String.fromCharCode(code);
        });

        document.getElementById('find-printer').onclick = requestPrinter;
        document.getElementById('connect-printer').onclick = initPrinter;
        document.getElementById('cut-printer').onclick = cutPrinter;


        const ESC_INIT = [0x1b, 0x40];
const ESC_BIT_IMAGE = [0x1b, 0x2a]
const DOTS_DENSITY = 24
const LUMINANCE = {
    RED: 0.299,
    GREEN: 0.587,
    BLUE: 0.114
}
const LINE_FEED = 0x0a;

function calculateLuminance(pixel) {
    return LUMINANCE.RED * pixel[0] + LUMINANCE.GREEN * pixel[1] + LUMINANCE.BLUE * pixel[2]
}

function calculateSlice(x, y, image) {
    const threshold = 127;
    let slice = 0;
    
    for (let bit = 0; bit < 8; bit++) {
        if ((y + bit) >= image.length)
            continue;

        luminance = calculateLuminance(image[y + bit][x])

        slice |= (luminance < threshold ? 1 : 0) << 7 - bit
    }

    return slice;
}

function collectStripe(x, y, image) {
    let slices = [];
    let z = y + DOTS_DENSITY;

    let i = 0
    while (y < z && i < 3){
      slices.push(calculateSlice(x, y, image));

      y += 8
    }

    return slices;
}

function manipulateImage(image) {
    let data = [];
    const imageWidth = image[0].length;

    for (let y = 0; y < image.length; y += DOTS_DENSITY){
        data.push(...ESC_BIT_IMAGE, 33, (0x00ff & imageWidth), (0xff00 & imageWidth) >> 8);

        for (let x = 0; x < imageWidth; x++) {
            data.push(...collectStripe(x, y, image));
        }

        data.push(LINE_FEED);
    }

    return data;
}

function printImage(image) {
    let transformedImage = [];

    transformedImage.push(...ESC_INIT);

    transformedImage.push(...manipulateImage(image));
    console.log(transformedImage)
    return new Uint8Array(transformedImage);
}

const testImage = document.getElementById("test-image")
testImage.addEventListener('click', e => {
    console.log(testImage)
    '\x1B' + '\x40';
    const data = printImage('\x1B'+ '\x2A'+ '\x00'+ '\x04'+ '\x00'+ '\xFF'+ '\x7E'+ '\x3C'+ '\x18')
    console.log(data)
    startPrint(device, data);
    
})

    </script>
</body>

</html>